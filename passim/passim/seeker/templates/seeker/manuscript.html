{% extends "layout.html" %}
{% load i18n %}

{% block breadcrumbs %}
  <div class="breadcrumbs">
      <a href="{% url 'home' %}">Home</a>
      &rsaquo; Search Manuscript
  </div>
{% endblock %}

{% block content %}

  <div>

    {% if authenticated %}
      <!-- Upper part of the search-a-manuscript interface -->

      <div id="manuscript_top">
        <!-- Provide tabs to choose the action -->
        <ul class="nav nav-tabs">
          <li class="active"><a data-toggle="tab" href="#tab_search">Search</a></li>
          <li><a data-toggle="tab" href="#tab_list">List</a></li>
          {% if is_passim_uploader %}
            <li><a data-toggle="tab" href="#tab_upload">Upload</a></li>
          {% endif %}
        </ul>

        <!-- Next, provide the contents -->
        <div class="tab-content clearfix">
          <!-- Search tab -->
          <div class="tab-pane active" id="tab_search">
            <div class="panel panel-default">
              <form id="manuscriptsearch" method='get' action="{% url 'library_search' %}" >
                <div>
                  <!-- Be sure to add csrf -->
                  {% csrf_token %}

                  <!-- Search interface: what manuscript to look for and what are the results -->
                  <div class="row">
                    <div class="col-sm-6">
                      <p>Manuscript to look for:</p>
                      <table>
                        <tr>
                          <td>COUNTRY</td>
                          <td style="width: 100%;">
                            <input name='country' class='form-control typeahead countries input-sm' type="text" 
                                   {% if searchform.country.value %}value='{{searchform.country.value}}'{% endif %}
                                   placeholder="Country..."
                                   onkeyup="ru.passim.form_submit(event);">
                          </td>
                        </tr>
                        <tr>
                          <td>CITY</td>
                          <td style="width: 100%;">
                            <input name='city' class='form-control typeahead cities input-sm' type="text" 
                                   {% if searchform.city.value %}value='{{searchform.city.value}}'{% endif %}
                                   placeholder="City..."
                                   onkeyup="ru.passim.form_submit(event);">
                          </td>
                        </tr>
                        <tr>
                          <td>LIBRARY</td>
                          <td style="width: 100%;">
                            <input name='library' class='form-control typeahead libraries input-sm' type="text" 
                                   {% if searchform.library.value %}value='{{searchform.library.value}}'{% endif %}
                                   placeholder="Name of library..."
                                   onkeyup="ru.passim.form_submit(event);">
                          </td>
                        </tr>
                        <tr>
                          <td>SIGNATURE</td>
                          <td style="width: 100%;">{{searchform.signature}}</td>
                        </tr>
                        <tr>
                          <td colspan="2" align="right">
                            <span><i>(right now the search only yields libraries)</i></span>
                              <!-- Submit the search form -->
                              <a role="button" class="btn btn-sm jumbo-3" onclick="$(this).closest('form').submit();">Search</a>
                          </td>
                        </tr>
                      </table>
                    </div>
                    <div class="col-sm-6">
                      <p>Results:</p>
                      <!-- The results -->
                      {% if object_list %}
                        <!-- Possible matching sermon ID's -->
                        <div id="result_manuscript_ids" style="min-height:500px;">

                        </div>
                      {% else %}
                      <p><i>No results</i></p>
                      {% endif %}
                    </div>
                  </div>

                  <!-- A bit more space at the bottom-->
                  <div class="row">&nbsp;</div>
                </div>

                <!-- Lower part: button to add an additional search field -->
                <div id="search_manuscript_add">
                  <span>
                    <a class="btn btn-xs jumbo-2" role="button" href="">Add additional search field</a>
                  </span>
                </div>
              </form>
            </div>
          </div>

          <!-- List tab -->
          <div class="tab-pane" id="tab_list">
            <div class="panel panel-default">
              {% if object_list %}

                <h3>Manuscripts</h3>
                <div class="row">
                    <div class="col-sm-4"><span>Total: </span><span>{{entrycount}}</span></div>
                    <div class="col-sm-8">
                    <span class="step-links pull-right">

                    {% include 'pagination.html' %}

                    </span>
                    </div>
                </div>
                <div class="row">
                  <div class="col-md-12">
                    <table class="table table-hover">
                      <thead><tr><th class="hidden">id</th><th>Name</th><th>From</th><th>Until</th><th><!-- Buttons --></th></tr></thead>
                      <tbody>
                      {% for man in object_list %}
                        <tr class="dict-entry">
                          <td class="hidden"> {{ man.id }}</td>
                          <td style="width: 100%;">
                            <span class="manuscript-name">{{man.name}}</span>
                          </td>
                          <!-- Dates for this manuscript -->
                          <td class="manuscript-date" align="right">{{man.yearstart}}</td>
                          <td class="manuscript-date" align="right">{{man.yearfinish}}</td>
                          <!-- Buttons for this author-->
                          <td style="min-width: 80px;">
                            <form>
                              {% csrf_token %}
                              <!-- information on this manuscript -->
                              <a role="button" class="btn btn-xs jumbo-3" title="Information" data-toggle="collapse" data-target="#man-info-{{man.id}}">
                                <span class="glyphicon glyphicon-info-sign"></span>
                              </a>
                            </form>
                          </td>
                        </tr>

                        <!-- Information on this manuscript -->
                        <tr id="man-info-{{man.id}}" class="collapse">
                          <td colspan="2">
                            <table>
                              <thead><tr><th>Field</th><th>Value</th></tr></thead>
                              <tbody>
                                <tr><td>Library name</td><td>{{man.library.name}}</td></tr>
                                <tr><td>Library city</td><td>{{man.library.city.name}}</td></tr>
                                <tr><td>Origin</td><td>{{man.origin.name}}</td></tr>
                                <tr><td>Sermons</td><td>{{man.sermons.count}}</td></tr>
                              </tbody>
                            </table>
                          </td>
                          <td>&nbsp;</td>
                        </tr>

                      {% endfor %}
                      </tbody>
                    </table>
                  </div>
                </div>
                <div class="pagination">
                    <span class="step-links">

                    {% include 'pagination.html' %}

                    </span>
                </div>

              {% else %}
                <p>No manuscripts have been found.</p>
              {% endif %}

              </div>

          </div>

          {% if is_passim_uploader %}
          <!-- Upload tab -->
          <div class="tab-pane" id="tab_upload">
            <div id="import_main" class="row container">
              <form action="{% url 'import_ecodex' %}" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <!-- Room for the filename to appear -->
                <div class="col-md-6 form-group" id="main-import_info"
                     sync-progress="{% url 'sync_progress' %}?synctype=ecodex"
                     targetid="manuscript_data_import"
                     targeturl="{% url 'import_ecodex' %}">
                  <div class="input-group">
                    <span>Specify the e-codex XML file with the manuscript data</span>
                    <span class="input-group-btn">
                      <span class="btn btn-default btn-xs btn-file">
                        Browse...
                        <input id="id_files_field" name="files_field" required="" multiple="" type="file" oninput="ru.passim.seeker.import_data('main');" />
                      </span>
                    </span>
                  </div>
            
                </div>
                <!-- Progress of upload indicator -->
                <div class="col-md-6">
                  <progress class="hidden" style="width:100%;" id="main-import_progress" value="0" min="0" max="100"></progress>
                </div>
                <!-- Any error reporting -->
                <div id="main-import_error"></div>
              </form>

              <!-- Import information -->
              <div id="manuscript_data_import" class="project-part hidden"></div>
            </div>

          </div>
          {% endif %}
        </div>

      </div>



    {% else %}
      <div class="explanation">
        <p>Dear user, you are <b>not</b> logged in.</p>
        <p>Unfortunately this means that you will not be able to perform any searches.</p>
        <p>Should you want to work with Passim, here are your options:
          <ul>
            <li><a class="btn btn-info btn-xs" href="{% url 'login' %}">Login</a> - if you already have an account</li> 
            <li><a class="btn btn-warning btn-xs" href="{% url 'signup' %}">Sign up</a> - if you don't have an account yet</li>
          </ul>
        </p>
      </div>
    {% endif %}
    
  </div>


{% endblock content %}
